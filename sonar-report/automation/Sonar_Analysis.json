{
  "name": "Sonar Analysis",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "=0 12 * * 5"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        0,
        -40
      ],
      "id": "696410f5-246e-4d74-b51f-d40a1b338154",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "sendTo": "george.farias@f4g.com.br",
        "subject": "={{ $json.output.subject }}",
        "message": "={{ $json.output.body }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1820,
        -140
      ],
      "id": "6bc8688e-c59f-4bbe-818e-f2dbf1bec8b1",
      "name": "Gmail",
      "webhookId": "62037e33-a860-4e97-bc03-17c815335d7d",
      "executeOnce": true,
      "credentials": {
        "gmailOAuth2": {
          "id": "9eY5yubWIBMcDRl1",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://sonarcloud.io/api/projects/search?organization={{$json.ORGANIZATION}}&ps=100",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 10000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        460,
        -40
      ],
      "id": "49531af8-3c1a-4ae0-8f3f-6e91cd6e5df2",
      "name": "Get Data",
      "executeOnce": false,
      "credentials": {
        "githubApi": {
          "id": "leqgDcgVWMXdmn3K",
          "name": "GitHub account"
        },
        "httpBearerAuth": {
          "id": "XHp2QrK54NhI8Krk",
          "name": "Bearer Auth account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Voc√™ analisar√° o relat√≥rio da qualidade de c√≥digo abaixo:\n\nData atual: {{ $today.format('dd/MM/yyyy') }}\n\n1. **current** ‚Äî Dados da consulta atual: {{ JSON.stringify($json.projects) }}\n\n2. *historical* - Dados das consultas anteriores.\n\n",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=Voc√™ √© um Analista de Qualidade de C√≥digo de n√≠vel s√™nior com vasta experi√™ncia em m√©tricas de engenharia de software, DevOps e qualidade cont√≠nua. Sua miss√£o √© analisar semanalmente os dados de m√∫ltiplos reposit√≥rios provenientes do SonarCloud, fornecidos em formato JSON. Cada reposit√≥rio cont√©m m√©tricas como cobertura de testes, n√∫mero de bugs, code smells, duplica√ß√£o de c√≥digo, vulnerabilidades e linhas de c√≥digo.\n\nSua tarefa √© gerar um relat√≥rio em formato JSON com os seguintes campos:\n\n- `subject`: linha de assunto do e-mail com o padr√£o: `\"An√°lise da Qualidade do C√≥digo - <Data do Relat√≥rio>\"`\n- `body`: conte√∫do HTML estruturado, conforme instru√ß√µes abaixo.\n\n## Instru√ß√µes para o campo `body` (HTML)\n\n- N√£o use `<html>`, `<head>` ou `<body>` completos.\n- Use `<h2>` e `<h3>` para t√≠tulos, `<ul>` e `<li>` para listas, e `<strong>` para √™nfase.\n- Utilize emojis para chamar aten√ß√£o para bons e maus desempenhos.\n- Compare os dados da semana atual com os dados anteriores (caso fornecidos).\n- Destaque:\n  - Projetos com melhoria significativa em cobertura ‚úÖ\n  - Redu√ß√µes de bugs ou vulnerabilidades üõ°Ô∏è\n  - Projetos com aumento preocupante de problemas üö®\n\n## Regras de An√°lise:\n\n1. Analise cada projeto individualmente e gere um resumo.\n2. Compare com a semana anterior (caso voc√™ receba ambos os conjuntos de dados: atual e anterior).\n3. Destaque os projetos com maiores evolu√ß√µes positivas e negativas.\n4. Ao final, escreva uma se√ß√£o com recomenda√ß√µes para o time de engenharia.\n5. Use uma linguagem profissional, clara e com sugest√µes pr√°ticas.\n6. Priorize m√©tricas de cobertura, bugs e vulnerabilidades como principais indicadores.\n7. Ordene os projetos por criticidade (maior n√∫mero de problemas primeiro).\n\nVoc√™ receber√° os dados no seguinte formato:\n\n```json\n[\n  {\n    \"id\": \"ID do projeto\",\n    \"key\": \"chave t√©cnica\",\n    \"name\": \"nome do projeto\",\n    \"measures\": [\n      {\"metric\": \"coverage\", \"value\": \"65.8\"},\n      {\"metric\": \"bugs\", \"value\": \"3\"},\n      {\"metric\": \"code_smells\", \"value\": \"179\"},\n      {\"metric\": \"duplicated_lines_density\", \"value\": \"7.2\"},\n      {\"metric\": \"ncloc\", \"value\": \"92897\"},\n      {\"metric\": \"vulnerabilities\", \"value\": \"0\"}\n    ]\n  }\n]\n````\n\nBaseado nesses dados, produza o relat√≥rio em JSON no seguinte modelo:\n\n```json\n{\n\t\"subject\": \"An√°lise da Qualidade do C√≥digo - (Data de hoje no formato DD/MM/AAAA)\",\n\t\"body\": \"<HTML formatado conforme instru√ß√µes com insights por projeto, compara√ß√µes com a semana anterior se dispon√≠vel, e uma se√ß√£o de recomenda√ß√µes finais>\"\n}\n```\n\nCaso receba apenas os dados da semana atual (sem compara√ß√£o com dados anteriores), baseie-se apenas nos valores absolutos, destacando:\n\n- Cobertura abaixo de 50% üö´\n- Bugs ou vulnerabilidades presentes ‚ö†Ô∏è\n- Duplica√ß√£o acima de 10% üìõ\n\nAo fim do relat√≥rio, escreva um par√°grafo com recomenda√ß√µes para melhoria cont√≠nua da qualidade dos projetos.\n\nSe os dados anteriores forem fornecidos, compare as m√©tricas com a semana anterior e destaque as varia√ß√µes (positivas ou negativas) em percentual e n√∫mero absoluto.\n\nSeja preciso, visualmente atrativo, e √∫til para equipes de engenharia e gest√£o t√©cnica.\n\n\nExemplo de uma estrutura esperada, usar como modelo apenas:\n\n[\n  {\n    \"output\": {\n      \"subject\": \"An√°lise da Qualidade do C√≥digo - 23/05/2025\",\n      \"body\": \"<h2>üìä Relat√≥rio Semanal de Qualidade do C√≥digo</h2>\\n<p>Data do relat√≥rio: <strong>23/05/2025</strong></p>\\n\\n<h3>üîç Vis√£o Geral</h3>\\n<ul>\\n    <li><strong>Projetos analisados:</strong> 5</li>\\n    <li><strong>Crit√©rios principais:</strong> Cobertura de testes, Bugs, Vulnerabilidades, Duplica√ß√£o de c√≥digo</li>\\n</ul>\\n\\n<h3>üìà Destaques Positivos</h3>\\n<ul>\\n    <li><strong>meuexame-frontend:</strong> Sem vulnerabilidades e boa cobertura (34.0%) ‚úÖ</li>\\n    <li><strong>interlis-reports:</strong> Sem bugs e duplica√ß√£o zero üõ°Ô∏è</li>\\n</ul>\\n\\n<h3>üö® Pontos de Aten√ß√£o</h3>\\n<ul>\\n    <li><strong>interlis-frontend:</strong> Cobertura baixa (25.1%), 16 bugs e alta duplica√ß√£o (15.2%) ‚ö†Ô∏è</li>\\n    <li><strong>meuexame-backend:</strong> 6 vulnerabilidades encontradas ‚ö†Ô∏è</li>\\n    <li><strong>interlis-backend:</strong> Presen√ßa de bugs (3) e coverage mediano (71.0%) üü°</li>\\n</ul>\\n\\n<h3>üìå An√°lise por Projeto</h3>\\n<table border=\\\"1\\\" cellspacing=\\\"0\\\" cellpadding=\\\"6\\\" style=\\\"border-collapse:collapse;font-family:sans-serif;width:100%;\\\">\\n    <thead style=\\\"background:#f8f9fa;\\\">\\n        <tr>\\n            <th>Projeto</th>\\n            <th>Cobertura</th>\\n            <th>Bugs</th>\\n            <th>Vulnerabilidades</th>\\n            <th>Duplica√ß√£o</th>\\n            <th>Code Smells</th>\\n            <th>Status</th>\\n        </tr>\\n    </thead>\\n    <tbody>\\n        <tr>\\n            <td><strong>interlis-frontend</strong></td>\\n            <td>\\n                <div style='background:#e9ecef;width:100px;border-radius:4px;overflow:hidden;'>\\n                    <div style='background:#dc3545;width:25.1%;height:12px;'></div>\\n                </div>\\n                <span style='font-size:12px;'>25.1%</span>\\n            </td>\\n            <td>16 ‚ö†Ô∏è</td>\\n            <td>0 ‚úÖ</td>\\n            <td>15.2% üìõ</td>\\n            <td>1240</td>\\n            <td>üî¥</td>\\n        </tr>\\n        <tr>\\n            <td><strong>interlis-backend</strong></td>\\n            <td>\\n                <div style='background:#e9ecef;width:100px;border-radius:4px;overflow:hidden;'>\\n                    <div style='background:#ffc107;width:71.0%;height:12px;'></div>\\n                </div>\\n                <span style='font-size:12px;'>71.0%</span>\\n            </td>\\n            <td>3</td>\\n            <td>0 ‚úÖ</td>\\n            <td>7.0%</td>\\n            <td>193</td>\\n            <td>üü°</td>\\n        </tr>\\n        <tr>\\n            <td><strong>meuexame-backend</strong></td>\\n            <td>\\n                <div style='background:#e9ecef;width:100px;border-radius:4px;overflow:hidden;'>\\n                    <div style='background:#ffc107;width:33.4%;height:12px;'></div>\\n                </div>\\n                <span style='font-size:12px;'>33.4%</span>\\n            </td>\\n            <td>0 ‚úÖ</td>\\n            <td>6 ‚ö†Ô∏è</td>\\n            <td>0.7%</td>\\n            <td>37</td>\\n            <td>üü°</td>\\n        </tr>\\n        <tr>\\n            <td><strong>meuexame-frontend</strong></td>\\n            <td>\\n                <div style='background:#e9ecef;width:100px;border-radius:4px;overflow:hidden;'>\\n                    <div style='background:#ffc107;width:34.0%;height:12px;'></div>\\n                </div>\\n                <span style='font-size:12px;'>34.0%</span>\\n            </td>\\n            <td>3</td>\\n            <td>0 ‚úÖ</td>\\n            <td>6.1%</td>\\n            <td>61</td>\\n            <td>üü°</td>\\n        </tr>\\n        <tr>\\n            <td><strong>interlis-reports</strong></td>\\n            <td>\\n                <div style='background:#e9ecef;width:100px;border-radius:4px;overflow:hidden;'>\\n                    <div style='background:#dc3545;width:22.8%;height:12px;'></div>\\n                </div>\\n                <span style='font-size:12px;'>22.8%</span>\\n            </td>\\n            <td>0 ‚úÖ</td>\\n            <td>3 ‚ö†Ô∏è</td>\\n            <td>0.0% ‚úÖ</td>\\n            <td>2</td>\\n            <td>üü¢</td>\\n        </tr>\\n    </tbody>\\n</table>\\n\\n<h3>üîß Recomenda√ß√µes</h3>\\n<ul>\\n    <li>Priorizar a melhoria da cobertura de testes especialmente no <strong>interlis-frontend</strong>.</li>\\n    <li>Trabalhar ativamente na redu√ß√£o do n√∫mero de bugs e code smells neste projeto.</li>\\n    <li>Monitorar as vulnerabilidades cr√≠ticas no <strong>meuexame-backend</strong>.</li>\\n    <li>Realizar revis√µes regulares do c√≥digo para melhoria cont√≠nua.</li>\\n</ul>\"\n    }\n  }\n]"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        1380,
        -140
      ],
      "id": "2745c941-3611-44b6-aa36-645fb20efc6d",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "gpt-4o"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1320,
        80
      ],
      "id": "4d6e394a-5be7-4364-9f96-f641b1f9c561",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "BHXusSEU10unDNKa",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "gpt-memory-store-sonar"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        1480,
        80
      ],
      "id": "2a60d2a8-69a7-493c-9b16-59827b10cbf9",
      "name": "Redis Chat Memory",
      "credentials": {
        "redis": {
          "id": "HKdSx38e77S833S7",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"subject\": \"An√°lise da Qualidade do C√≥digo - (DATA FORMATO - DD/MM/AAAA)\",\n  \"body\": \"<HTML com an√°lise atual vs hist√≥rica>\"\n}\n"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        1620,
        80
      ],
      "id": "64ac3e55-e95b-4e8a-88c8-127acd03002c",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "09e4a75e-5f5b-4028-a2fe-0519040a560f",
              "name": "ORGANIZATION",
              "value": "f4g-sistemas-e-solucoes",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        220,
        -40
      ],
      "id": "f3b832bf-8b7b-4fdd-a3fc-5d3f7cc86dc3",
      "name": "Set Params"
    },
    {
      "parameters": {
        "batchSize": "=1",
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        900,
        -40
      ],
      "id": "aa0989e8-190c-4355-ae58-6778ead355d2",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "url": "=https://sonarcloud.io/api/measures/component?component={{ $json.key}}&metricKeys=ncloc,bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 10000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1080,
        60
      ],
      "id": "e130abba-66eb-4a32-ac15-cdec7f981654",
      "name": "Get Project Detail",
      "executeOnce": false,
      "credentials": {
        "githubApi": {
          "id": "leqgDcgVWMXdmn3K",
          "name": "GitHub account"
        },
        "httpBearerAuth": {
          "id": "XHp2QrK54NhI8Krk",
          "name": "Bearer Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return [\n  ...$input.first().json.components\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        680,
        -40
      ],
      "id": "ef5581c1-f442-4a5d-ae30-8f7df18098f2",
      "name": "Get Array"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "projects",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        1080,
        -140
      ],
      "id": "e3113564-f21a-4c5c-9ad0-07ca0e2e52fa",
      "name": "Aggregate"
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Set Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Data": {
      "main": [
        [
          {
            "node": "Get Array",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Gmail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Set Params": {
      "main": [
        [
          {
            "node": "Get Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Project Detail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Project Detail": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Array": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Sao_Paulo",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "9da16605-99c6-4361-a55e-d8ab4ce117f9",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "680b771266285e0b2805aa12c56e24ddd5aa291181c2c29d2ca50bff81261932"
  },
  "id": "YKPQod85Q9AFpEnw",
  "tags": [
    {
      "createdAt": "2025-05-20T16:31:04.983Z",
      "updatedAt": "2025-05-20T16:31:04.983Z",
      "id": "YePntUlhLK5IUSTv",
      "name": "reports"
    },
    {
      "createdAt": "2025-05-20T16:31:15.518Z",
      "updatedAt": "2025-05-20T16:31:15.518Z",
      "id": "vSLxRvwJiQOzeGVX",
      "name": "production"
    },
    {
      "createdAt": "2025-05-20T16:43:04.301Z",
      "updatedAt": "2025-05-20T16:43:04.301Z",
      "id": "Ng6Yh4ZQW2L4O4sx",
      "name": "george"
    }
  ]
}